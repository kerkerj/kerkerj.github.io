<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>kerkerj</title>
    <link>http://blog.kerkerj.in/categories/url/index.xml</link>
    <description>Recent content on kerkerj</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <copyright>This work is licensed under a Creative Commons Attribution-ShareAlike 4.0 International License.</copyright>
    <atom:link href="http://blog.kerkerj.in/categories/url/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>tld_length 在 Rails session_store 與 HTTP URL 的設定</title>
      <link>http://blog.kerkerj.in/blog/tld_length-%E5%9C%A8-rails-session_store-%E8%88%87-http-url-%E7%9A%84%E8%A8%AD%E5%AE%9A/</link>
      <pubDate>Thu, 20 Oct 2016 10:47:58 +0800</pubDate>
      
      <guid>http://blog.kerkerj.in/blog/tld_length-%E5%9C%A8-rails-session_store-%E8%88%87-http-url-%E7%9A%84%E8%A8%AD%E5%AE%9A/</guid>
      <description>&lt;p&gt;工作上 rails 在每個 stage 的 domain 長度都不太一樣&lt;/p&gt;

&lt;p&gt;例如 production 是 &lt;code&gt;example.com&lt;/code&gt;，staging 是 &lt;code&gt;kerkerj.staging.example.com&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-ruby&#34;&gt;MyApp::Application.config.session_store :redis_session_store, {
  key: &#39;example_session_token&#39;,
  domain: :all,
  tld_length: 4,
  serializer: :hybrid,
  redis: {
    host: &amp;quot;....&amp;quot;,
    key_prefix: &amp;quot;...&amp;quot;,
    expire_after: 7.day,
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;相關原始碼: &lt;a href=&#34;https://github.com/rails/rails/blob/ee30661a3cf93ebf0f99905434f4989344549820/actionpack/lib/action_dispatch/middleware/cookies.rb#L283-L299&#34;&gt;action_dispatch/middleware/cookies.rb&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;在這裡的 &lt;code&gt;tld_length&lt;/code&gt; 就是看你 domain 的 tld 想設定到哪就寫多少&lt;/p&gt;

&lt;p&gt;以 &lt;code&gt;kerkerj.staging.example.com&lt;/code&gt; 為例，想要 &lt;code&gt;example.com&lt;/code&gt; 就是 2，想要 &lt;code&gt;kerkerj.staging.example.com&lt;/code&gt; 就是 4&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;而在 Rails App 裡，在 &lt;code&gt;config.action_dispatch.tld_length&lt;/code&gt; (或 &lt;code&gt;ActionDispatch::Http::URL.tld_length&lt;/code&gt; ) 設定的 &lt;code&gt;tld_length&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;在 &lt;a href=&#34;http://api.rubyonrails.org/classes/ActionDispatch/Http/URL.html#method-i-domain&#34;&gt;rails api document&lt;/a&gt; 的 &lt;code&gt;#domain&lt;/code&gt; 有用法&lt;/p&gt;

&lt;p&gt;原始碼則解釋得更清楚 &lt;a href=&#34;https://github.com/rails/rails/blob/master/actionpack/lib/action_dispatch/http/url.rb#L38-L43&#34;&gt;actionpack/lib/action_dispatch/http/url.rb&lt;/a&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;gt; ActionDispatch::Http::URL.extract_domain(&amp;quot;kerkerj.staging.example.com&amp;quot;, 1)
=&amp;gt; &amp;quot;example.com&amp;quot;
&amp;gt; ActionDispatch::Http::URL.extract_domain(&amp;quot;kerkerj.staging.example.com&amp;quot;, 2)
=&amp;gt; &amp;quot;staging.example.com&amp;quot;
&amp;gt; ActionDispatch::Http::URL.extract_domain(&amp;quot;kerkerj.staging.example.com&amp;quot;, 3)
=&amp;gt; &amp;quot;kerkerj.staging.example.com&amp;quot;
&amp;gt; ActionDispatch::Http::URL.extract_domain(&amp;quot;example.com&amp;quot;, 1)
=&amp;gt; &amp;quot;example.com&amp;quot;
&amp;gt; ActionDispatch::Http::URL.extract_domain(&amp;quot;example.com&amp;quot;, 3)
=&amp;gt; &amp;quot;example.com&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;tld_length&lt;/code&gt; 在兩邊的實作與意義上不同，需要注意。&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>