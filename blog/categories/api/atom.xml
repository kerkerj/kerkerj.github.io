<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Api | kerkerj]]></title>
  <link href="http://kerkerj.github.io/blog/categories/api/atom.xml" rel="self"/>
  <link href="http://kerkerj.github.io/"/>
  <updated>2014-10-24T20:47:09+08:00</updated>
  <id>http://kerkerj.github.io/</id>
  <author>
    <name><![CDATA[kerkerj]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[[API-d24] - 實戰開發 - 刪除 TODO Task API With Mongoose]]></title>
    <link href="http://kerkerj.github.io/blog/2014/10/24/api-d24/"/>
    <updated>2014-10-24T20:42:36+08:00</updated>
    <id>http://kerkerj.github.io/blog/2014/10/24/api-d24</id>
    <content type="html"><![CDATA[<p><a href="https://github.com/kerkerj/ithome-RestfulAPIDemo/tree/Day24">Github 參考</a></p>

<p>還記得昨天說要偷懶一下嗎 XD</p>

<p>因為刪除真的很簡單!</p>

<p>我們前面走過了新增、修改、讀取了</p>

<p>刪除？哪有什麼困難的呢! XD</p>

<p>直接看 code 吧!</p>

<p>routes/users.js:</p>

<pre><code class="javascript">// Delete a todo task
router.delete('/:user_id/todos/:todo_id', function(req, res) {
    var user_id = req.params.user_id;
    var todo_id = req.params.todo_id;

    TODO.remove(
        { _id: todo_id, user_id: user_id },
        function (err) {
            if (err) {
                res.status(400).json(
                    { error: "delete data error"}
                );
            } else {
                res.status(201).json(
                    { success: "true" }
                );
            }
        }
    );
});
</code></pre>

<p>非常的簡單!</p>

<p>先抓到 user_id, todo_id 後</p>

<p>使用 .remove 的方法，下 WHERE 條件，並在 callback 作處理</p>

<p>就完成了!</p>

<p>試試看吧!</p>

<p><img src="https://dl.dropboxusercontent.com/u/12400343/images/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202014-10-13%203.39.09.png" alt="image" /></p>

<p>是不是非常的簡單呢！</p>

<p>我們已經完成 CRUD API 操作了！</p>

<p>接下來幾天會稍作一些細節上的處理!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[API-d23] - 實戰開發 - 修改 TODO Task API With Mongoose]]></title>
    <link href="http://kerkerj.github.io/blog/2014/10/23/api-d23/"/>
    <updated>2014-10-23T14:59:33+08:00</updated>
    <id>http://kerkerj.github.io/blog/2014/10/23/api-d23</id>
    <content type="html"><![CDATA[<p><a href="https://github.com/kerkerj/ithome-RestfulAPIDemo/tree/Day23">Github 參考</a></p>

<p>接上篇，我們已經可以拿到 todo list 了</p>

<p>也可以拿到特定的 todo task</p>

<p>再來我們就可以編輯特定的 todo task 了對吧?</p>

<p>不囉唆直接進入程式碼</p>

<p>routes/users.js</p>

<pre><code class="javascript">// Update a todo task
router.put('/:user_id/todos/:todo_id', function(req, res) {
    var user_id = req.params.user_id;
    var todo_id = req.params.todo_id;
    var data = req.body;

    TODO.update(
        { _id: todo_id, user_id: user_id },
        { $set: { content: data.content } },
        function (err, num, raw, results) {
            if (err) {
                res.status(400).json(
                    { error: "update data error" }
                );
            } else {
                TODO.find({ _id: todo_id, user_id: user_id }, function (err, results) {
                    res.status(201).json(
                        results[0]
                    );
                });
            }
        }
    );
});
</code></pre>

<p>這次拿資料要拿三組: user_id, todo_id, 以及 data from req.body</p>

<pre><code>var user_id = req.params.user_id;
var todo_id = req.params.todo_id;
var data = req.body;
</code></pre>

<p>body 的資料很簡單，就是欲修改的 content 的資料:</p>

<pre><code>{ "content": "想修改的資料" }
</code></pre>

<p>再來，除了是使用 .update 方法以及同樣要下 WHERE 參數外， .update 方法還多了一個參數:</p>

<pre><code>{ _id: todo_id, user_id: user_id },
{ $set: { content: data.content } },
</code></pre>

<p>$set 的意思等同於 SQL 語法中的 SET</p>

<p>如果沒有加 $set 變成下面這樣:</p>

<pre><code>{ _id: todo_id, user_id: user_id },
{ content: data.content } ,
</code></pre>

<p>整個資料就會被洗掉，變成只有 <code>{ content: data.content }</code></p>

<p>因此有沒有加 $set 差很多哦</p>

<p>後面一樣是 callback 的處理</p>

<p>都寫好後，實際開 POSTMAN 試試看吧!</p>

<p>記得要使用 <code>PUT</code> 來丟 request</p>

<p>例子如下，我把原本的 buy milk 改成 buy milk and banana</p>

<p><img src="https://dl.dropboxusercontent.com/u/12400343/images/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202014-10-13%203.31.57.png" alt="image" /></p>

<p>這樣離完成 API 就不遠啦!</p>

<p>明天就稍微休息一下吧 XD</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[API-d22] - 實戰開發 - 讀取 TODO Task API With Mongoose]]></title>
    <link href="http://kerkerj.github.io/blog/2014/10/22/api-d22/"/>
    <updated>2014-10-22T19:13:00+08:00</updated>
    <id>http://kerkerj.github.io/blog/2014/10/22/api-d22</id>
    <content type="html"><![CDATA[<p><a href="https://github.com/kerkerj/ithome-RestfulAPIDemo/tree/Day22">Github 參考</a></p>

<p>如果有使用 MongoDB client 的話就可以搭配使用會比較有感覺</p>

<p>Mac 我是使用 Robomongo，算很好上手~</p>

<p>今天要來實作讀取的部分</p>

<p>讀取有分兩種，一種是讀取 list</p>

<p>另一種是讀取特定某個 todo task，今天兩種都會實作</p>

<p>首先我們先實作 get todo list</p>

<p>因為若要拿到特定的 todo task，需要 todo task 的 id</p>

<p>而我們現在還不曉得 todo task 的 id 是多少，我們只知道 user_id</p>

<p>因此就先從 list 下手</p>

<p>routes/users.js:</p>

<pre><code class="javascript">// Get todo list
router.get('/:user_id/todos', function(req, res) {
    var user_id = req.params.user_id;

    TODO.find(
        {user_id: user_id},
        function (err, results) {
            if (err) {
                res.status(400).json(
                    { error: "can not find data" }
                );
            } else {
                res.status(200).json(
                    results
                );
            }
        }
    );
});
</code></pre>

<p>上面程式碼的意思是，先抓到 uri 的 user_id</p>

<p>再來就直接進 db 找，find() 的第一個參數為:</p>

<pre><code>{user_id: user_id},
</code></pre>

<p>可以想像成是 SQL 語法中的 WHERE 條件</p>

<pre><code>SELECT * WHERE user_id = 'user_id' FROM todos
</code></pre>

<p>而 callback 則是針對 error 或 results 作處理</p>

<p>試著將 server 跑起來，然後使用 POSTMAN 丟 GET request 試試看</p>

<p>如果沒有資料，就利用昨天實作的 POST API 新增幾個吧！</p>

<p>記得 url 中輸入的 user_id 要在 DB 中有該 user 的資料才找的到資料哦</p>

<p><img src="https://dl.dropboxusercontent.com/u/12400343/images/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202014-10-13%203.17.08.png" alt="images" /></p>

<p>如此一來就有 task id 了!</p>

<p>再來就來實作讀取特定 id 的 task API 吧!</p>

<p>程式碼如下</p>

<p>routes/user.js:</p>

<pre><code>// Get a todo task
router.get('/:user_id/todos/:todo_id', function(req, res) {
    var user_id = req.params.user_id;
    var todo_id = req.params.todo_id;

    TODO.find(
        { _id: todo_id, user_id: user_id},
        function (err, results) {
            if (err) {
                res.status(400).json(
                    { error: "can not find data" }
                );
            } else {
                res.status(200).json(
                    results[0]
                );
            }
        }
    );
});
</code></pre>

<p>這次更簡單了，user_id 及 todo_id 都是從 url 上取值</p>

<p>接著一樣使用 where 條件，將值帶入找資料</p>

<p>最後交給 callback 處理回傳值</p>

<p>將 server 跑起來，試著先從todo list 複製某一筆 _id 的值</p>

<p>丟到 url 中試試看</p>

<p><img src="https://dl.dropboxusercontent.com/u/12400343/images/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202014-10-13%203.21.51.png" alt="image" /></p>

<p>如此一來，讀取特定 task 的 API 也完成囉!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[API-d21] - 實戰開發 - 新增 TODO Task API With Mongoose]]></title>
    <link href="http://kerkerj.github.io/blog/2014/10/21/api-d21/"/>
    <updated>2014-10-21T18:58:06+08:00</updated>
    <id>http://kerkerj.github.io/blog/2014/10/21/api-d21</id>
    <content type="html"><![CDATA[<p><a href="https://github.com/kerkerj/ithome-RestfulAPIDemo/tree/Day21">Github 參考</a></p>

<p>昨天我們了解了如何拿 url params 以及 request data</p>

<p>今天我們就來使用他，對資料庫做存取</p>

<p>由於使用到資料庫，因此我們要加入資料庫的 driver</p>

<p>我們用的是 <code>mongoose</code> 套件</p>

<p>app.js:</p>

<pre><code class="javascript">// 在最上方加入
var mongoose = require('mongoose');

// 在某個地方連接資料庫
var db_uri = "mongodb://192.168.33.10:27017/TODOs";
mongoose.connect(db_uri);
</code></pre>

<p>在這邊我是使用了虛擬機的 DB，因此是 <code>mongodb://192.168.33.10:27017/TODOs</code></p>

<p>DB 的名稱為 <code>TODOs</code></p>

<p>這樣在程式一跑起來時，就會連接資料庫了!</p>

<p>再來我們就要設定在對資料庫做 CRUD 時，所需要做的事情</p>

<p>首先我們先要定義 schema，</p>

<p>雖然 mongodb 是 schema-free，但是官方文件也有提到最好還是有固定的 schema 避免記憶體 allocate 時出現問題，而程式撰寫時邏輯也不會因此而過於複雜</p>

<p>這時候我們就需要 model 資料夾了，在 model 資料夾中新增一個 todos.js</p>

<p>裡面要放的就是 todo task 的 schema</p>

<p>內容如下:</p>

<p>models/todos.js:</p>

<pre><code>'use strict';

var mongoose = require('mongoose');

// Define our todo schema
var TODOschema   = new mongoose.Schema({
    user_id: String,
    content: String,
    created_at: Date,
    updated_at: Date
});

// Export the Mongoose model
module.exports = mongoose.model('TODO', TODOschema);
</code></pre>

<p>我們定義了幾個東西 user_id, content, created_at, updated_at</p>

<p>其實 ObjectID 中已經有包含建立資訊了，其實 created_at 是可以省略掉的，不過在這邊還是加一下</p>

<p>注意下面這行:</p>

<pre><code>module.exports = mongoose.model('TODO', TODOschema);
</code></pre>

<p>&lsquo;TODO&rsquo; 在這邊是 Collection (RDBMS 中的 table) 的名稱</p>

<p>在 mongoose 中，會自動複數化，所以在 Mongodb 中的 Collection name 會變成 &lsquo;todos&rsquo; ，</p>

<p>雖然只是小小的一行，但是蠻重要的</p>

<p>最後將這個 model exports 成一個 mongoose.model 物件</p>

<p>那我們什麼時候會用到這個 model 物件呢?</p>

<p>就是在 routes/user.js 中，</p>

<p>routes/users.js:</p>

<pre><code>var TODO = require('../models/todos');
</code></pre>

<p>這樣在 users.js 中就可以使用 TODO 這個物件了!</p>

<p>我們先試著編輯 POST 的 route，拿到 POST 資料後，將資料轉成 TODO 的物件，存到 mongodb 裏</p>

<p>以下是 routes/users.js 中的 post 程式碼段</p>

<p>簡單來說就是先抓到 uri 的參數以及 post data</p>

<p>並且使用 models/todos.js 的 model 新建立一個 todo 物件</p>

<p>並將該物件用 post data 初始化，</p>

<p>初始化完後就執行寫入 DB 的行為, 若寫入成功則回傳 201 + data</p>

<p>失敗則回傳 400 bad request</p>

<pre><code>// Create a todo task
router.post('/:user_id/todos', function(req, res) {
    var user_id = req.params.user_id;
    var data = req.body;

    // insert to db
    var todo = new TODO();
    todo.user_id = user_id;
    todo.content = data.content;
    todo.created_at = Date.now();
    todo.updated_at = Date.now();

    todo.save(function (err) {
        if (err) {
            res.status(400).json(
                { error: "insert db error" }
            );
        } else {
            res.status(201).json(
                todo
            );
        }
    });
});
</code></pre>

<p>試著執行伺服器看看，並且使用 POSTMAN 丟 request 如下:</p>

<p><img src="https://dl.dropboxusercontent.com/u/12400343/images/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202014-10-13%202.54.57.png" alt="image" /></p>

<p>POST 的 raw data</p>

<pre><code>{ "content": "buy milk" }
</code></pre>

<p>於是就完成了一個 POST 新增 TODO 的 API 了！</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[API-d20] - 實戰開發 - Routes 2, Get Params and Request Data]]></title>
    <link href="http://kerkerj.github.io/blog/2014/10/20/api-d20/"/>
    <updated>2014-10-20T18:46:12+08:00</updated>
    <id>http://kerkerj.github.io/blog/2014/10/20/api-d20</id>
    <content type="html"><![CDATA[<p><a href="https://github.com/kerkerj/ithome-RestfulAPIDemo/tree/Day20">Github 參考</a></p>

<p>接著我們要根據我們開之前寫好的 <a href="http://docs.todolist7.apiary.io/">文件</a> 來開發:</p>

<p>要有下列 routes</p>

<pre><code class="javascript">TODOs
GET /user/{user_id}/todos/
POST /user/{user_id}/todos/
GET /user/{user_id}/todos/{id}
PUT /user/{user_id}/todos/{id}
DELETE /user/{user_id}/todos/{id}
</code></pre>

<p>這樣的需求其實可以用 namespace 實作，不過我們偷懶一點，直接指向 /user 就好</p>

<p>所以在 app.js 加入</p>

<pre><code>var users = require('./routes/users');
app.use('/user', users);
</code></pre>

<p>所以會變這樣:</p>

<pre><code>var express = require('express');
var app = express();

// Set routers
var index = require('./routes/index');
var users = require('./routes/users');

app.use('/', index);
app.use('/user', users);

module.exports = app;
</code></pre>

<p>不過看起來我們缺少 routes/users.js，所以我們也來新增一個</p>

<p>routes/users.js 內容如下</p>

<pre><code>'use strict';

var express = require('express');
var router = express.Router();

router.get('/', function(req, res) {

});

router.post('/', function(req, res) {

});

router.get('/', function(req, res) {

});

router.put('/', function(req, res) {

});

router.delete('/', function(req, res) {

});

module.exports = router;
</code></pre>

<p>好像有那麼一點符合我們要的 routes 了</p>

<p>我們在把每個詳細的 uri 加入</p>

<p>在這邊要注意</p>

<p>因為我們在 app.js 中把 uers.js 加入了 (&lsquo;/users&rsquo;, users)</p>

<p>這個 route</p>

<p>因此在 users.js 中設定的所有 route 都是接在 <code>/users/</code> 後面的</p>

<p>要注意哦</p>

<p>修改後的檔案:</p>

<pre><code>'use strict';

var express = require('express');
var router = express.Router();

// Get todo list
router.get('/:user_id/todos', function(req, res) {
    res.status(200).json( {success: "GET lists"} );
});

// Create a todo task
router.post('/:user_id/todos', function(req, res) {
    res.status(200).json( {success: "POST"} );
});

// Get a todo task
router.get('/:user_id/todos/:todo_id', function(req, res) {
    res.status(200).json( {success: "GET 1 task"} );
});

// Update a todo task
router.put('/:user_id/todos/:todo_id', function(req, res) {
    res.status(200).json( {success: "PUT"} );
});

// Delete a todo task
router.delete('/:user_id/todos/:todo_id', function(req, res) {
    res.status(200).json( {success: "DELETE"} );
});

module.exports = router;```
</code></pre>

<p>將 server 重啟，試著對這些網址丟丟看</p>

<p>這時候使用瀏覽器應該就沒辦法丟 GET 以外的要求了對吧?</p>

<p>此時 chrome extension - POSTMAN 就該上場啦！</p>

<p>打開 POSTMAN 就可以送以下的 request 囉!</p>

<pre><code>GET http://localhost:3000/user/kerkerj/todos  
POST http://localhost:3000/user/kerkerj/todos  
GET http://localhost:3000/user/kerkerj/todos/1  
PUT http://localhost:3000/user/kerkerj/todos/1  
DELETE http://localhost:3000/user/kerkerj/todos/1  
</code></pre>

<p>因為剛剛程式裡面都只讓他回傳 success，因此還沒有太大的作用，</p>

<p>不過已經有感覺了對吧!! XD</p>

<h2>Get params from url</h2>

<p>我們現在先針對以下這段程式碼作進一步的改寫:</p>

<pre><code>// Get a todo task
router.get('/:user_id/todos/:todo_id', function(req, res) {
    res.status(200).json( 
        { 
            success: "GET 1 task", 
            user: req.params.user_id,
            todo_id: req.params.todo_id
        } );
});
</code></pre>

<p>存檔並打開 server，存取 <a href="http://localhost:3000/user/test/todos/1">http://localhost:3000/user/test/todos/1</a></p>

<p>就可以看到回傳值是:</p>

<pre><code>{
    "success": "GET 1 task",
    "user": "kerkerj",
    "todo_id": "1"
}
</code></pre>

<p>所以又學到一招了!</p>

<p>先設定想要抓哪一段網址，例如:</p>

<p><code>/:user_id/todos/:todo_id</code></p>

<p>前面有加冒號的就是這段網址是要被抓成一個參數</p>

<p>而冒號後面接的就是之後在下面要使用到的名字</p>

<p>要接網址的參數的拿法 - req.params.{???}</p>

<p>例如:</p>

<p>req.params.user_id</p>

<p>req.params.todo_id</p>

<p>拿到了網址的參數，就可以對資料庫做進一步的查詢</p>

<h2>Get request data</h2>

<p>那要怎麼拿到 request 的 data 呢?</p>

<p>他並不存在于網址列上啊?</p>

<p>這時候就要加入 <code>body-parser</code> 了!</p>

<p>他會在接收到 request 時，幫我們做過處理後，再傳到每個 request 該去的 router 裏</p>

<p>在 app.js 中加入</p>

<pre><code>// 最上面
var bodyParser = require('body-parser');

// 加在 router 前面，切記!!
app.use( bodyParser.json() );
app.use( bodyParser.urlencoded({ extended: true }) );

app.use('/', index);
app.use('/user', users);
</code></pre>

<p>接著在 users.js 中的 POST 區塊中加入兩行:</p>

<pre><code>// Create a todo task
router.post('/:user_id/todos', function(req, res) {
    var data = req.body;

    res.status(200).json( {success: data } );
});
</code></pre>

<p>開啓 server, 用下圖的方式對 server 做 request:</p>

<p><img src="https://dl.dropboxusercontent.com/u/12400343/images/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202014-10-09%2023.00.10.png" alt="image" /></p>

<p>記得要加入 header -</p>

<p>Content-Type - application/json</p>

<p>Data 要選擇 raw data - 使用自己寫的 json 格式</p>

<p>就可以看到下面的回傳格式了!</p>

<p>透過拿到 url params 以及 request data</p>

<p>我們就可以使用這些資料來對資料庫做存取了!</p>
]]></content>
  </entry>
  
</feed>
